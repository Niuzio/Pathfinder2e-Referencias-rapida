<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editor WYSIWYG — Pathfinder 2e</title>
  <style>
    :root {
      --bg: #f4f5f6; --card: #fff; --ink: #19202d; --muted: #57606a;
      --line: #dfe1e6; --accent: #2684ff; --warn: #de350b; --ok: #36b37e;
    }
    body.dark {
      --bg: #17191e; --card: #22262e; --ink: #e6e7e9; --muted: #8b95a7;
      --line: #2c333f; --accent: #4c9aff; --warn: #ff7452; --ok: #57d9a3;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font: 14px/1.5 ui-sans-serif, system-ui;
      background: var(--bg); color: var(--ink);
      display: grid;
      grid-template-rows: auto 1fr auto;
      grid-template-areas:
        "hd"
        "main"
        "ft";
    }
    header {
      grid-area: hd;
      background: var(--card);
      border-bottom: 1px solid var(--line);
      position: sticky; top: 0; z-index: 10;
      padding: 0 16px;
    }
    nav { display: flex; }
    .menu { list-style: none; display: flex; }
    .menu > li { position: relative; }
    .menu > li > a {
      display: block; padding: 12px 16px;
      color: var(--ink); text-decoration: none;
      cursor: pointer;
    }
    .menu > li:hover > a { background: hsla(210,80%,90%,.5); }
    .submenu {
      display: none;
      position: absolute; top: 100%; left: 0;
      background: var(--card); border: 1px solid var(--line);
      min-width: 200px; list-style: none; padding: 4px 0;
      z-index: 20;
    }
    .menu > li:hover > .submenu { display: block; }
    .submenu li { padding: 0; margin: 0; }
    .submenu li label,
    .submenu li button {
      display: block; width: 100%;
      text-align: left; padding: 8px 12px;
      background: none; border: none; font: inherit;
      color: var(--ink); cursor: pointer;
    }
    .submenu li button:hover,
    .submenu li label:hover { background: var(--line); }
    .submenu li input[type="text"] {
      width: calc(100% - 24px);
      margin: 4px 12px; padding: 6px;
      border: 1px solid var(--line);
      border-radius: 4px;
      background: var(--bg); color: var(--ink);
    }
    #fileInput { display: none; }

    .layout {
      grid-area: main;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
    }
    .panel.split { height: calc(100vh - 230px); }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      flex: 1; overflow: auto;
    }
    thead th {
      position: sticky; top: 0;
      background: var(--card);
      padding: 8px; text-align: left;
      color: var(--muted);
      border-bottom: 1px solid var(--line);
    }
    tbody td { padding: 8px; vertical-align: top; }
    .ce {
      min-height: 28px; padding: 6px;
      border: 1px dashed transparent;
      border-radius: 4px;
    }
    .ce:focus {
      outline: none;
      border-color: var(--accent);
      background: hsla(210,100%,50%,.05);
    }
    .ce.placeholder:empty:before {
      content: attr(data-ph); color: var(--muted);
    }
    .row-actions { display: flex; gap: 4px; }
    .status {
      margin: 8px 0; font-size: 13px;
    }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--warn); }

    .preview {
      overflow: auto; flex: 1;
    }
    .card {
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .title { font-weight: 700; }
    .subtitle { color: var(--muted); margin: 4px 0; }
    .traits {
      display: flex; flex-wrap: wrap; gap: 6px; margin: 4px 0;
    }
    .trait {
      background: var(--line);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 12px;
    }
    .desc { white-space: pre-wrap; margin: 4px 0; }
    .bullets { margin: 0 0 0 16px; }

    #toolbar {
      position: fixed; bottom: 24px; right: 24px;
      display: none; gap: 4px; padding: 6px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,.1);
    }
    #toolbar button { padding: 4px 6px; }
    #toolbar .sep {
      width: 1px; background: var(--line);
      margin: 0 6px;
    }
  </style>
</head>
<body>

<header>
  <nav>
    <ul class="menu">
      <li>
        <a>Archivo ▾</a>
        <ul class="submenu">
          <li><label for="fileInput">Abrir archivo…</label></li>
          <li><input type="text" id="urlInput" placeholder="URL raw GitHub" /></li>
          <li><button id="btnLoadUrl">Cargar URL</button></li>
          <li><label>Variable: <input type="text" id="varName" placeholder="data_x" /></label></li>
          <li><label>Salida .js: <input type="text" id="fileName" placeholder="data_x.js" /></label></li>
          <li><button id="btnDownload">Descargar .js</button></li>
        </ul>
      </li>
      <li>
        <a>Editar ▾</a>
        <ul class="submenu">
          <li><button id="btnAdd">Añadir fila</button></li>
          <li><button id="btnValidate">Validar</button></li>
          <li><button id="btnClear">Vaciar todo</button></li>
        </ul>
      </li>
      <li>
        <a>Ver ▾</a>
        <ul class="submenu">
          <li><button id="btnDark">Modo oscuro</button></li>
          <li><button id="btnRestore">Restaurar tema</button></li>
        </ul>
      </li>
    </ul>
  </nav>
  <input type="file" id="fileInput" accept=".js" />
</header>

<div class="layout">

  <div class="panel split">
    <div id="status" class="status err">
      Sin datos. Abra un archivo o pegue una URL.
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:16ch">title</th>
          <th style="width:16ch">subtitle</th>
          <th style="width:16ch">reference</th>
          <th style="width:16ch">traits</th>
          <th style="min-width:200px">description</th>
          <th style="width:20ch">bullets</th>
          <th style="width:14ch">Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="panel">
    <strong>Vista previa</strong>
    <div id="preview" class="preview"></div>
  </div>

</div>

<div id="toolbar">
  <button data-cmd="bold"><strong>B</strong></button>
  <button data-cmd="italic"><em>I</em></button>
  <button data-cmd="underline"><u>U</u></button>
  <div class="sep"></div>
  <button data-cmd="insertUnorderedList">• List</button>
  <button data-cmd="insertOrderedList">1. List</button>
  <div class="sep"></div>
  <button id="btnLink">Link</button>
  <button data-cmd="unlink">Unlink</button>
  <div class="sep"></div>
  <button id="btnClearFmt">Clear</button>
</div>

<script>
let dataset = [];
let varNameDetected = null;
let focusedCell = null;
const $ = s => document.querySelector(s);

function setStatus(msg, ok = false) {
  const st = $('#status');
  st.textContent = msg;
  st.className = 'status ' + (ok ? 'ok' : 'err');
}

function toRawUrl(u) {
  return u.includes('/blob/')
    ? u.replace('github.com/', 'raw.githubusercontent.com/')
        .replace('/blob/', '/')
    : u;
}

function parseVarJs(text) {
  const nameRe = new RegExp('(?:^|\\W)([\\w$]+)\\s*=\\s*\

\[');
  const nameMatch = nameRe.exec(text);
  if (!nameMatch) {
    throw new Error('No se encontró asignación de variable a un array.');
  }
  const varName = nameMatch[1];
  const eqPos = text.indexOf('=', nameMatch.index);
  const openPos = text.indexOf('[', eqPos);
  if (openPos < 0) throw new Error('No se encontró "[" tras la asignación.');

  let depth = 0, closePos = -1;
  for (let i = openPos; i < text.length; i++) {
    if (text[i] === '[') depth++;
    else if (text[i] === ']') {
      depth--;
      if (depth === 0) { closePos = i; break; }
    }
  }
  if (closePos < 0) {
    throw new Error('No se encontró cierre "]" correspondiente.');
  }

  const jsArray = text.slice(openPos, closePos + 1);
  let arr;
  try {
    arr = (new Function('return ' + jsArray))();
  } catch (e) {
    throw new Error('Error al evaluar array: ' + e.message);
  }
  if (!Array.isArray(arr)) {
    throw new Error('La variable extraída no es un array.');
  }

  varNameDetected = varName;
  return arr;
}

function downloadJs(name, arr) {
  const safeName = name.match(/^[\w$]+$/) ? name : 'data_x';
  const js = safeName + ' = ' + JSON.stringify(arr, null, 2) + ';\n';
  const blob = new Blob([js], { type: 'application/javascript' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = $('#fileName').value.trim() || (safeName + '.js');
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function ensure(i) {
  dataset[i] ||= {
    title: '', subtitle: '', reference: '',
    traits: [], description: '', bullets: []
  };
}

function renderTable() {
  const tbody = $('#tbody');
  tbody.innerHTML = '';
  dataset.forEach((it, idx) => {
    ensure(idx);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="title" data-ph="Título">${it.title}</div></td>
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="subtitle" data-ph="Subtítulo">${it.subtitle}</div></td>
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="reference" data-ph="Referencia">${it.reference}</div></td>
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="traits" data-ph="trait1, trait2">${(it.traits||[]).join(', ')}</div></td>
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="description" data-ph="Descripción…">${it.description}</div></td>
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="bullets" data-ph="Una línea = bullet">${(it.bullets||[]).join('\n')}</div></td>
      <td class="row-actions">
        <button data-act="up"    data-idx="${idx}">↑</button>
        <button data-act="down"  data-idx="${idx}">↓</button>
        <button data-act="dup"   data-idx="${idx}">⎘</button>
        <button data-act="del"   data-idx="${idx}" style="color:var(--warn)">🗑</button>
      </td>`;
    tbody.appendChild(tr);
  });
  document.querySelectorAll('.ce').forEach(el =>
    el.classList.toggle('placeholder', !el.textContent.trim())
  );
  refreshPreview();
}

function refreshPreview() {
  const pr = $('#preview');
  pr.innerHTML = '';
  dataset.forEach(it => {
    const c = document.createElement('div'); c.className = 'card';
    const t = Object.assign(document.createElement('div'), { className: 'title',    innerText: it.title });
    const s = Object.assign(document.createElement('div'), { className: 'subtitle', innerText: it.subtitle });
    const r = Object.assign(document.createElement('div'), { className: 'subtitle', innerText: it.reference });
    const trts = document.createElement('div'); trts.className = 'traits';
    (it.traits||[]).forEach(x => {
      const sp = document.createElement('span'); sp.className = 'trait'; sp.innerText = x;
      trts.appendChild(sp);
    });
    const d = document.createElement('div'); d.className = 'desc';
    d.innerHTML = it.description.replace(/\n/g,'<br>');
    const ul = document.createElement('ul'); ul.className = 'bullets';
    (it.bullets||[]).forEach(x => {
      const li = document.createElement('li'); li.innerText = x;
      ul.appendChild(li);
    });
    c.append(t,s,trts,r,d,ul);
    pr.appendChild(c);
  });
}

document.addEventListener('input', e => {
  const ce = e.target.closest('.ce');
  if (!ce) return;
  const i = +ce.dataset.idx, f = ce.dataset.field;
  ensure(i);
  const v = ce.innerText;
  if (f === 'traits')       dataset[i][f] = v.split(',').map(x => x.trim()).filter(Boolean);
  else if (f === 'bullets') dataset[i][f] = v.split('\n').map(x => x.trim()).filter(Boolean);
  else                      dataset[i][f] = v;
  saveLocal();
  renderTable();
});

document.addEventListener('click', e => {
  const b = e.target.closest('button[data-act]');
  if (!b) return;
  const i = +b.dataset.idx, act = b.dataset.act;
  if (act === 'del')   dataset.splice(i,1);
  if (act === 'dup')   dataset.splice(i+1,0, JSON.parse(JSON.stringify(dataset[i])));
  if (act === 'up'   && i>0)      dataset.splice(i-1,0, dataset.splice(i,1)[0]);
  if (act === 'down' && i<dataset.length-1) dataset.splice(i+1,0, dataset.splice(i,1)[0]);
  saveLocal(); renderTable();
});

function showToolbar(el) {
  focusedCell = el;
  const r = el.getBoundingClientRect(), tb = $('#toolbar');
  tb.style.left = r.left + 'px';
  tb.style.top  = (r.bottom + 6) + 'px';
  tb.style.display = 'flex';
}
function hideToolbar() { $('#toolbar').style.display = 'none'; }

document.addEventListener('focusin', e => {
  const ce = e.target.closest('.ce');
  if (ce) showToolbar(ce);
});
document.addEventListener('click', e => {
  if (!e.target.closest('.ce') && !e.target.closest('#toolbar')) hideToolbar();
});

$('#toolbar').addEventListener('click', e => {
  const cmd = e.target.closest('button')?.dataset.cmd;
  if (cmd) {
    document.execCommand(cmd,false,null);
    focusedCell.dispatchEvent(new Event('input'));
  } else if (e.target.id === 'btnLink') {
    const url = prompt('URL:');
    if (url) {
      document.execCommand('createLink',false,url);
      focusedCell.dispatchEvent(new Event('input'));
    }
  } else if (e.target.id === 'btnClearFmt') {
    document.execCommand('removeFormat',false,null);
    document.execCommand('unlink',false,null);
    focusedCell.dispatchEvent(new Event('input'));
  }
});

$('#fileInput').addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      dataset = parseVarJs(reader.result);
      $('#varName').value = varNameDetected;
      setStatus(`Cargado ${f.name}`, true);
      renderTable();
    } catch (err) {
      setStatus(err.message, false);
    }
  };
  reader.readAsText(f);
});

$('#btnLoadUrl').onclick = async () => {
  const u = toRawUrl($('#urlInput').value.trim());
  if (!u) return setStatus('URL vacía', false);
  try {
    const res = await fetch(u);
    if (!res.ok) throw new Error(res.statusText);
    const txt = await res.text();
    dataset = parseVarJs(txt);
    $('#varName').value = varNameDetected;
    setStatus('Cargado desde URL', true);
    renderTable();
  } catch (err) {
    setStatus(err.message, false);
  }
};

$('#btnAdd').onclick      = () => { dataset.push({}); saveLocal(); renderTable(); };
$('#btnClear').onclick    = () => { if (confirm('¿Vaciar todo?')) { dataset = []; saveLocal(); renderTable(); } };
$('#btnValidate').onclick = () => {
  const errs = [];
  if (!Array.isArray(dataset)) errs.push('No es un array');
  dataset.forEach((o,i) => { if (!o.title?.trim()) errs.push(`#${i+1} falta title`); });
  setStatus(errs.length ? errs.join(' | ') : 'OK ✔', errs.length === 0);
};

$('#btnDark').onclick    = () => {
  document.body.classList.toggle('dark');
  localStorage.setItem('pf2e_theme', document.body.classList.contains('dark'));
};
$('#btnRestore').onclick = () => {
  document.body.classList.remove('dark');
  localStorage.removeItem('pf2e_theme');
};
if (localStorage.getItem('pf2e_theme') === 'true') {
  document.body.classList.add('dark');
}

function saveLocal() {
  localStorage.setItem('pf2e_editor', JSON.stringify({ dataset }));
}
function loadLocal() {
  try {
    const st = JSON.parse(localStorage.getItem('pf2e_editor'));
    if (st?.dataset) {
      dataset = st.dataset;
      $('#varName').value = varNameDetected || '';
      setStatus('Datos restaurados', true);
    }
  } catch {}
}
window.onload = () => {
  loadLocal();
  if (dataset.length) renderTable();
  else setStatus('Sin datos. Abra un archivo o pegue una URL.', false);
};

$('#btnDownload').onclick = () => {
  if (!varNameDetected && !$('#varName').value.trim()) {
    varNameDetected = prompt('Nombre de variable:', 'data_x');
  }
  downloadJs($('#varName').value.trim() || varNameDetected, dataset);
};
</script>

</body>
</html>
