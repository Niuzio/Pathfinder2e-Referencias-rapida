<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Editor PF2e ‚Äì WYSIWYG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background:#0f1115; color:#e6e6e6; }
    header { padding: 10px; background:#12151b; display: flex; gap: 10px; align-items: center; }
    main { display: grid; grid-template-columns: 300px 1fr; height: calc(100vh - 50px); }
    aside { border-right: 1px solid #222; overflow: auto; padding: 10px; }
    section { padding: 10px; overflow: auto; }
    input, select, textarea { width: 100%; margin-bottom: 6px; padding: 6px; background:#12151b; color:#e6e6e6; border: 1px solid #273041; border-radius: 4px; }
    button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
    button.primary { background:#1e88e5; color: white; }
    button.danger { background:#c62828; color: white; }
    .card { border: 1px solid #222; padding: 8px; margin-bottom: 6px; border-radius: 4px; background:#0f131a; }
    #editor { background: white; color: black; }
  </style>
</head>
<body>
  <header>
    <input type="file" id="fileInput" accept=".js" multiple>
    <button id="exportBtn" class="primary">Exportar</button>
    <span id="status"></span>
  </header>
  <main id="app">
    <aside>
      <div v-for="(item, idx) in items" :key="idx" class="card" @click="selectItem(idx)" style="cursor: pointer">
        <div v-if="item.header">
          <strong>Secci√≥n:</strong> {{ item.header }}
        </div>
        <div v-else>
          <strong>{{ item.title }}</strong><br>
          <small>{{ item.icon }}</small>
        </div>
      </div>
    </aside>
    <section v-if="current">
      <div v-if="current.header">
        <label>Header</label>
        <input v-model="current.header">
      </div>
      <div v-else>
        <label>T√≠tulo</label>
        <input v-model="current.title">
        <label>Icon</label>
        <input v-model="current.icon">
        <label>Subtitle</label>
        <input v-model="current.subtitle">
        <label>Reference</label>
        <input v-model="current.reference">
        <label>Descripci√≥n</label>
        <div id="editor"></div>
        <label>Bullets</label>
        <div v-for="(b, bi) in current.bullets" :key="bi" style="display: flex; gap: 4px; margin-bottom: 4px;">
          <input v-model="current.bullets[bi]">
          <button class="danger" @click.prevent="current.bullets.splice(bi,1)">X</button>
        </div>
        <button @click.prevent="current.bullets.push('')">A√±adir bullet</button>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/acorn@8/dist/acorn.min.js"></script>
  <script src="https://unpkg.com/prettier@3/standalone.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    const { createApp, reactive } = Vue;
    const vm = reactive({
      items: [],
      current: null,
      varName: '',
      fileName: '',
      files: null
    });

    function fromAssignmentJs(text) {
      const ast = acorn.parse(text, { ecmaVersion: 2020 });
      const decl = ast.body.find(n => n.type === 'VariableDeclaration');
      const name = decl.declarations[0].id.name;
      const value = eval(text.replace(name + ' =', ''));
      return value;
    }

    function toAssignmentJs(varName, items) {
      const code = `${varName} = ${JSON.stringify(items, null, 2)};`;
      return prettier.format(code, { parser: "babel" });
    }

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const files = e.target.files;
      if (!files.length) return;

      if (files.length > 1) {
        vm.files = [];
        for (const file of files) {
          const text = await file.text();
          vm.files.push({
            fileName: file.name, // üîπ Guardar nombre original
            varName: file.name.replace(/\.js$/i, ''),
            items: fromAssignmentJs(text)
          });
        }
      } else {
        const file = files[0];
        vm.fileName = file.name; // üîπ Guardar nombre original
        const text = await file.text();
        vm.varName = file.name.replace(/\.js$/i, '');
        vm.items = fromAssignmentJs(text);
      }
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      if (vm.files && vm.files.length > 1) {
        vm.files.forEach(f => {
          const code = toAssignmentJs(f.varName, f.items);
          const blob = new Blob([code], { type: 'text/javascript;charset=utf-8' });
          saveAs(blob, f.fileName); // üîπ Usa el nombre original
        });
      } else {
        const fileName = vm.fileName || (vm.varName + '.js');
        const code = toAssignmentJs(vm.varName, vm.items);
        const blob = new Blob([code], { type: 'text/javascript;charset=utf-8' });
        saveAs(blob, fileName); // üîπ Usa el nombre original
      }
    });

    createApp({
      setup() {
        return vm;
      },
      mounted() {
        const quill = new Quill('#editor', { theme: 'snow' });
        quill.on('text-change', () => {
          if (vm.current && !vm.current.header) {
            vm.current.description = quill.root.innerHTML;
          }
        });
      },
      methods: {
        selectItem(idx) {
          vm.current = vm.items[idx];
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
