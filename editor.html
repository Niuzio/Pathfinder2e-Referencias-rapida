<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Editor PF2e – data_*.js</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa4ad; --accent:#7cc4ff; --bad:#ff6b6b; --ok:#80e27e; }
    body { background:var(--bg); color:var(--fg); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
    header { padding:14px 18px; border-bottom:1px solid #222831; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    header h1 { font-size:16px; margin:0 12px 0 0; }
    .pill { padding:6px 10px; border:1px solid #222831; border-radius:8px; background:#12151b; color:var(--muted);}
    main { display:grid; grid-template-columns: 360px 1fr; gap:0; min-height:calc(100vh - 58px); }
    aside { border-right:1px solid #222831; padding:12px; overflow:auto;}
    section { padding:12px; overflow:auto;}
    input[type="text"], select, textarea { width:100%; background:#12151b; color:#e6e6e6; border:1px solid #273041; border-radius:8px; padding:8px; }
    textarea { min-height:140px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    button { background:#172033; color:#dfe8f4; border:1px solid #24314a; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button.secondary { background:#12151b; color:#c7d2e1; }
    button.danger { background:#2b1518; border-color:#5a1f27; color:#ffb3ba; }
    .row { display:flex; gap:8px; align-items:center; }
    .col { display:flex; flex-direction:column; gap:6px; }
    .list { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
    .card { border:1px solid #222831; border-radius:10px; padding:10px; background:#0f131a; }
    .small { font-size:12px; color:var(--muted); }
    .ok { color:var(--ok); } .bad { color:var(--bad); }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #1a2130; padding:8px; text-align:left; vertical-align:top; }
    .tags { display:flex; gap:6px; flex-wrap:wrap;}
    .tag { background:#172033; border:1px solid #24314a; color:#9cc7ff; padding:3px 6px; border-radius:999px; font-size:12px;}
    .split { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .preview { border:1px dashed #273041; border-radius:8px; padding:10px; background:#0e141d; }
    .ghost { opacity:0.65; font-style:italic; color:#9aa4ad; }
    .drag { cursor:grab; }
  </style>
</head>
<body>
  <header>
    <h1>Editor PF2e – data_*.js</h1>
    <label class="pill"><input id="fileInput" type="file" accept=".js" multiple /></label>
    <input id="urlInput" class="pill" type="text" placeholder="Pega URL raw de GitHub (js/.../data_*.js)" style="min-width:320px" />
    <button id="loadUrlBtn" class="pill">Cargar URL</button>
    <button id="exportAllBtn" class="pill">Exportar todos</button>
    <span id="status" class="small"></span>
  </header>

  <main id="app">
    <aside>
      <div class="col card">
        <label>Buscar</label>
        <input v-model="q" type="text" placeholder="título, header, subtitle, bullet..." />
        <div class="row">
          <select v-model="filter.icon">
            <option value="">Cualquier icon</option>
            <option>single_action</option>
            <option>two_actions</option>
            <option>three_actions</option>
            <option>reaction</option>
            <option>free_action</option>
            <option>exploration</option>
            <option>campground</option>
            <option>bomb</option>
            <option>eye</option>
            <option>leaf</option>
            <option>paw</option>
            <option>hand-back-fist</option>
            <option>theater-masks</option>
            <option>lock-open</option>
            <option>compass</option>
            <option>church</option>
            <option>university</option>
          </select>
          <select v-model="filter.kind">
            <option value="">Todos</option>
            <option value="header">Secciones</option>
            <option value="action">Acciones</option>
          </select>
        </div>
        <div class="small">Archivos: {{ datasets.length }} | Ítems: {{ totalCount }} | Errores: <span :class="errorsCount? 'bad':'ok'">{{ errorsCount }}</span></div>
      </div>

      <div class="list">
        <div v-for="(ds, i) in datasets" :key="i" class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div><strong>{{ ds.fileName }}</strong></div>
              <div class="small">var: {{ ds.varName }} | items: {{ ds.items.length }}</div>
              <div class="small" v-if="ds.errors.length"><span class="bad">errores: {{ ds.errors.length }}</span></div>
              <div class="small" v-else><span class="ok">válido</span></div>
            </div>
            <div class="row">
              <button class="secondary" @click="selectDataset(i)">Abrir</button>
              <button class="danger" @click="removeDataset(i)">Quitar</button>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <section v-if="active !== null">
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div class="col" style="max-width:60%">
          <div class="row" style="gap:12px;">
            <div class="col">
              <label>Dataset</label>
              <input :value="datasets[active].fileName + ' ('+datasets[active].varName+')'" disabled />
            </div>
            <div class="col">
              <label>Esquema</label>
              <textarea :value="schemaPreview" disabled></textarea>
            </div>
          </div>
        </div>
        <div class="row" style="gap:8px;">
          <button @click="addHeader">Nueva sección</button>
          <button @click="addAction">Nueva acción</button>
          <button class="secondary" @click="exportOne">Exportar este .js</button>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th style="width:8%">#</th>
              <th style="width:10%">Tipo</th>
              <th>Título / Sección</th>
              <th style="width:16%">Icon</th>
              <th style="width:22%">Rasgos/Coste (derivado)</th>
              <th style="width:14%"></th>
            </tr>
          </thead>
          <tbody id="itemsTable">
            <tr v-for="(it, idx) in filtered" :key="idx" @click="selectItem(idx)" class="drag" title="Arrastra para reordenar">
              <td>{{ idx+1 }}</td>
              <td>{{ kindOf(it) }}</td>
              <td>
                <span v-if="it.header"><strong>{{ it.header }}</strong></span>
                <span v-else>{{ it.title }}</span>
                <div class="small ghost" v-if="!it.header && it.subtitle">{{ it.subtitle }}</div>
              </td>
              <td>{{ it.icon || '' }}</td>
              <td>
                <div class="tags">
                  <span v-for="t in derivedTraits(it)" :key="t" class="tag">{{ t }}</span>
                  <span v-if="derivedCost(it)" class="tag">{{ derivedCost(it) }}</span>
                </div>
              </td>
              <td>
                <button class="secondary" v-if="!it.header" @click.stop="duplicateItem(idx)">Duplicar</button>
                <button class="danger" @click.stop="deleteItem(idx)">Borrar</button>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="small ghost">Tip: arrastra filas para reordenar.</div>
      </div>

      <div v-if="selIndex !== null" class="split" style="margin-top:10px;">
        <div class="col">
          <div class="card" v-if="isHeader(current)">
            <div class="small">Editando: Sección</div>
            <label>Header</label>
            <input v-model="current.header" type="text" placeholder="Nombre de la sección" />
          </div>

          <div class="card" v-else>
            <div class="small">Editando: Acción</div>
            <label>Título</label>
            <input v-model="current.title" type="text" />
            <div class="row">
              <div class="col">
                <label>Icon</label>
                <input v-model="current.icon" type="text" placeholder="single_action, reaction, exploration..." />
              </div>
              <div class="col">
                <label>Subtitle</label>
                <input v-model="current.subtitle" type="text" />
              </div>
            </div>
            <label>Reference</label>
            <input v-model="current.reference" type="text" />
            <label>Descripción</label>
            <textarea v-model="current.description" placeholder="Texto (HTML o simple)"></textarea>

            <div class="col" style="margin-top:8px;">
              <label>Bullets</label>
              <div class="list" id="bulletsList">
                <div class="row" v-for="(b, bi) in (current.bullets || [])" :key="bi">
                  <input v-model="current.bullets[bi]" type="text" />
                  <button class="danger" @click.prevent="removeBullet(bi)">X</button>
                </div>
                <button @click.prevent="addBullet">Añadir bullet</button>
                <div class="small ghost">Tip: arrastra bullets para reordenar.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col">
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <div class="small">Validación</div>
              <div class="small" :class="valErrors.length?'bad':'ok'">
                {{ valErrors.length? (valErrors.length + ' errores'): 'Sin errores' }}
              </div>
            </div>
            <div class="preview" v-html="safePreview(current)"></div>
          </div>
          <div class="card">
            <div class="small">Objeto JSON</div>
            <textarea :value="currentJson" disabled></textarea>
          </div>
        </div>
      </div>
    </section>

    <section v-else class="col" style="align-content:center; justify-items:center;">
      <div class="card">
        Carga uno o más archivos .js con el formato IDENT = [ { header }, { title, icon, subtitle, description, reference, bullets } ].
      </div>
    </section>
  </main>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- Acorn -->
  <script src="https://cdn.jsdelivr.net/npm/acorn@8/dist/acorn.min.js"></script>
  <!-- Ajv -->
  <script src="https://cdn.jsdelivr.net/npm/ajv@8/dist/ajv7.min.js"></script>
  <!-- Prettier -->
  <script src="https://unpkg.com/prettier@3/standalone.js"></script>
  <script src="https://unpkg.com/prettier@3/parser-babel.js"></script>
  <!-- DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <!-- FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <script>
  const { createApp, reactive } = Vue;
  const AjvCtor = window.Ajv || window.ajv7 || window.ajv;

  // Discriminantes
  const isHeader = (it) => it && typeof it === 'object' && !!it.header && !it.title;
  const isAction = (it) => it && typeof it === 'object' && !!it.title;
  const kindOf   = (it) => isHeader(it) ? 'header' : 'action';

  // Derivados (solo para filtros/preview)
  function derivedTraits(it){
    if (!isAction(it)) return [];
    const b = (it.bullets || []).find(x => /^\s*Rasgos\s*:/i.test(x));
    if (!b) return [];
    return b.split(':').slice(1).join(':').split(',').map(s => s.trim()).filter(Boolean);
  }
  function derivedCost(it){
    if (!isAction(it)) return '';
    const b = (it.bullets || []).find(x => /^\s*Coste\s*:/i.test(x));
    if (!b) return '';
    return b.split(':').slice(1).join(':').trim();
  }

  // AST -> JS (subset seguro)
  function astToJs(node) {
    switch (node.type) {
      case 'ArrayExpression':
        return node.elements.map(el => astToJs(el));
      case 'ObjectExpression':
        const obj = {};
        for (const p of node.properties) {
          const key = p.key.type === 'Identifier' ? p.key.name : p.key.value;
          obj[key] = astToJs(p.value);
        }
        return obj;
      case 'Literal':
        return node.value;
      case 'TemplateLiteral':
        return node.quasis.map(q => q.value.cooked).join('');
      case 'UnaryExpression':
        if (node.operator === '-') return -astToJs(node.argument);
        if (node.operator === '+') return +astToJs(node.argument);
        return null;
      default:
        return null;
    }
  }

  // Detecta IDENT = [ ... ] y var/let/const IDENT = [ ... ]
  function parseJsArrayAssignment(code) {
    try {
      const ast = acorn.parse(code, { ecmaVersion: 2020, sourceType: 'script' });
      // AssignmentExpression
      for (const n of ast.body) {
        if (n.type === 'ExpressionStatement' &&
            n.expression &&
            n.expression.type === 'AssignmentExpression' &&
            n.expression.left.type === 'Identifier' &&
            n.expression.right.type === 'ArrayExpression') {
          return { varName: n.expression.left.name, items: astToJs(n.expression.right) };
        }
      }
      // VariableDeclaration
      for (const n of ast.body) {
        if (n.type === 'VariableDeclaration') {
          for (const d of n.declarations) {
            if (d.id.type === 'Identifier' && d.init && d.init.type === 'ArrayExpression') {
              return { varName: d.id.name, items: astToJs(d.init) };
            }
          }
        }
      }
    } catch(e) { /* fallback */ }
    // Fallback regex
    const m = code.match(/([A-Za-z_$][\w$]*)\s*=\s*(

\[[\s\S]*\]

);?/);
    if (m) {
      const varName = m[1];
      const arrText = m[2];
      try {
        const safe = arrText
          .replace(/(\w+)\s*:/g, '"$1":')
          .replace(/'([^']*)'/g, (_,x)=> JSON.stringify(x));
        return { varName, items: JSON.parse(safe) };
      } catch(e) {}
    }
    throw new Error('No se encontró una asignación IDENT = [ ... ]');
  }

  // Esquema (header | action)
  function buildSchema() {
    const headerSchema = {
      type: 'object',
      properties: { header: { type: 'string', minLength: 1 } },
      required: ['header'],
      additionalProperties: true
    };
    const actionSchema = {
      type: 'object',
      properties: {
        title: { type: 'string', minLength: 1 },
        icon: { type: 'string' },
        subtitle: { type: 'string' },
        description: { type: 'string' },
        reference: { type: 'string' },
        bullets: { type: 'array', items: { type: 'string' } }
      },
      required: ['title'],
      additionalProperties: true
    };
    return { type: 'array', items: { oneOf: [headerSchema, actionSchema] } };
  }

  // Serializer estable (respeta claves conocidas por tipo)
  function jsString(s){ return JSON.stringify(s); }
  function stringifyBullets(arr){
    if (!Array.isArray(arr)) return '[]';
    const lines = arr.map(s => `  ${jsString(s)}`).join(',\n');
    return `[\n${lines}\n]`;
  }
  function stringifyItem(it){
    if (isHeader(it)) return `{ header: ${jsString(it.header)} }`;
    const knownOrder = ['title','icon','subtitle','description','reference','bullets'];
    const parts = [];
    for (const k of knownOrder) {
      if (it[k] === undefined) continue;
      if (k === 'bullets') parts.push(`bullets: ${stringifyBullets(it[k])}`);
      else parts.push(`${k}: ${jsString(it[k])}`);
    }
    // extras no listados
    const known = new Set(knownOrder);
    Object.keys(it).filter(k => !known.has(k) && k !== 'header').forEach(k=>{
      parts.push(`${k}: ${jsString(it[k])}`);
    });
    return `{ ${parts.join(', ')} }`;
  }
  function toAssignmentJs(varName, items){
    const raw = `${varName} = [\n  ${items.map(stringifyItem).join(',\n  ')}\n];\n`;
    try { return prettier.format(raw, { parser:'babel', plugins:[prettierPlugins.babel] }); }
    catch { return raw; }
  }

  const app = createApp({
    data: () => ({
      datasets: [], // { fileName, varName, items, schema, errors: [] }
      active: null,
      q: '',
      filter: reactive({ icon:'', kind:'' }),
      selIndex: null,
      current: {},
    }),
    computed: {
      totalCount(){ return this.datasets.reduce((a,d)=>a + d.items.length, 0); },
      errorsCount(){ return this.datasets.reduce((a,d)=>a + d.errors.length, 0); },
      schemaPreview(){ return this.active===null ? '' : JSON.stringify(this.datasets[this.active].schema, null, 2); },
      filtered(){
        if (this.active===null) return [];
        const ds = this.datasets[this.active];
        const q = this.q.trim().toLowerCase();
        return ds.items.filter(it=>{
          const hayQ = !q || JSON.stringify(it).toLowerCase().includes(q);
          const okI = !this.filter.icon || (isAction(it) && (it.icon||'')===this.filter.icon);
          const okK = !this.filter.kind || (isHeader(it)?'header':'action')===this.filter.kind;
          return hayQ && okI && okK;
        });
      },
      currentJson(){ return JSON.stringify(this.current, null, 2); },
      valErrors(){
        if (this.active===null) return [];
        const ds = this.datasets[this.active];
        const ajv = new AjvCtor({ allErrors: true, strict:false });
        const validate = ajv.compile(ds.schema);
        const items = ds.items.slice();
        if (this.selIndex !== null) items[this.selIndex] = this.current;
        validate(items);
        return validate.errors || [];
      }
    },
    methods: {
      isHeader, isAction, kindOf, derivedTraits, derivedCost,
      safePreview(it){
        if (!it) return '';
        let html = '';
        if (isHeader(it)) {
          html = `<h3>${DOMPurify.sanitize(it.header||'')}</h3>`;
        } else {
          const t = DOMPurify.sanitize(it.title||'');
          const ic = DOMPurify.sanitize(it.icon||'');
          const sub = DOMPurify.sanitize(it.subtitle||'');
          const ref = DOMPurify.sanitize(it.reference||'');
          const desc = DOMPurify.sanitize(it.description||'');
          const bullets = (it.bullets||[]).map(b=>`<li>${DOMPurify.sanitize(b)}</li>`).join('');
          html = `<div><strong>${t}</strong> <span class="small">(${ic||'sin icon'})</span></div>
                  ${sub?`<div class="small">${sub}</div>`:''}
                  ${ref?`<div class="small ghost">${ref}</div>`:''}
                  <div style="margin-top:6px">${desc}</div>
                  ${bullets?`<ul>${bullets}</ul>`:''}`;
        }
        return html;
      },
      selectDataset(i){ this.active = i; this.selIndex = null; this.current = {}; this.$nextTick(this.attachDnD); },
      removeDataset(i){ if (this.active===i){ this.active=null; this.selIndex=null; this.current={}; } this.datasets.splice(i,1); },
      addHeader(){
        if (this.active===null) return;
        const it = { header:'Nueva sección' };
        this.datasets[this.active].items.push(it);
        this.selectItem(this.datasets[this.active].items.length - 1);
      },
      addAction(){
        if (this.active===null) return;
        const it = { title:'Nueva acción', icon:'', subtitle:'', description:'', reference:'', bullets:[] };
        this.datasets[this.active].items.push(it);
        this.selectItem(this.datasets[this.active].items.length - 1);
      },
      selectItem(i){
        this.selIndex = i;
        const src = this.datasets[this.active].items[i];
        this.current = JSON.parse(JSON.stringify(src));
        this.$nextTick(this.attachBulletsDnD);
      },
      duplicateItem(i){
        const ds = this.datasets[this.active];
        const src = ds.items[i];
        if (isHeader(src)) return;
        const copy = JSON.parse(JSON.stringify(src));
        copy.title = (copy.title||'') + ' (copia)';
        ds.items.splice(i+1, 0, copy);
      },
      deleteItem(i){
        if (!confirm('¿Borrar este elemento?')) return;
        this.datasets[this.active].items.splice(i,1);
        this.selIndex = null; this.current = {};
      },
      addBullet(){ if (!this.current.bullets) this.current.bullets = []; this.current.bullets.push(''); this.$nextTick(this.attachBulletsDnD); },
      removeBullet(i){ this.current.bullets.splice(i,1); },
      commitCurrent(){
        if (this.active===null || this.selIndex===null) return;
        this.datasets[this.active].items[this.selIndex] = JSON.parse(JSON.stringify(this.current));
        this.revalidate(this.active);
      },
      revalidate(i){
        const ds = this.datasets[i];
        const ajv = new AjvCtor({ allErrors: true, strict:false });
        const validate = ajv.compile(ds.schema);
        const ok = validate(ds.items);
        ds.errors = ok ? [] : (validate.errors || []);
      },
      exportOne(){
        if (this.active===null) return;
        this.commitCurrent();
        const ds = this.datasets[this.active];
        const code = toAssignmentJs(ds.varName, ds.items);
        const blob = new Blob([code], { type:'text/javascript;charset=utf-8' });
        saveAs(blob, ds.fileName);
      },
      exportAll(){
        this.commitCurrent();
        this.datasets.forEach(ds => {
          const code = toAssignmentJs(ds.varName, ds.items);
          const blob = new Blob([code], { type:'text/javascript;charset=utf-8' });
          saveAs(blob, ds.fileName);
        });
      },
      // Drag and drop reordenar filas
      attachDnD(){
        const tbody = document.getElementById('itemsTable');
        if (!tbody) return;
        Sortable.create(tbody, {
          handle: '.drag', animation: 150,
          onEnd: (evt) => {
            const ds = this.datasets[this.active];
            const oldIdx = evt.oldIndex;
            const newIdx = evt.newIndex;
            if (oldIdx === newIdx) return;
            const [it] = ds.items.splice(oldIdx,1);
            ds.items.splice(newIdx,0,it);
            if (this.selIndex === oldIdx) this.selIndex = newIdx;
          }
        });
      },
      // Drag and drop reordenar bullets
      attachBulletsDnD(){
        const list = document.getElementById('bulletsList');
        if (!list) return;
        const rows = list.querySelectorAll('.row');
        if (!rows.length) return;
        Sortable.create(list, {
          animation: 150, draggable: '.row',
          onEnd: (evt) => {
            const oldIdx = evt.oldIndex;
            const newIdx = evt.newIndex;
            if (oldIdx === newIdx) return;
            const [b] = this.current.bullets.splice(oldIdx,1);
            this.current.bullets.splice(newIdx,0,b);
          }
        });
      }
    }
  });

  const vm = app.mount('#app');

  // Carga desde archivos locales
  document.getElementById('fileInput').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    const status = document.getElementById('status');
    for (const f of files) {
      status.textContent = 'Cargando ' + f.name + '...';
      const text = await f.text();
      await loadTextAsDataset(text, f.name);
    }
    status.textContent = 'Listo';
    e.target.value = '';
  });

  // Carga desde URL raw de GitHub
  document.getElementById('loadUrlBtn').addEventListener('click', async () => {
    const input = document.getElementById('urlInput');
    const url = (input.value || '').trim();
    if (!url) return;
    const status = document.getElementById('status');
    status.textContent = 'Descargando ' + url + '...';
    try {
      const res = await fetch(url, { mode: 'cors' });
      const text = await res.text();
      const fileName = url.split('/').pop() || 'data.js';
      await loadTextAsDataset(text, fileName);
      status.textContent = 'Listo';
      input.value = '';
    } catch (e) {
      status.textContent = 'Error al descargar';
      alert('No se pudo descargar: ' + e.message);
    }
  });

  async function loadTextAsDataset(text, fileName){
    try {
      const { varName, items } = parseJsArrayAssignment(text);
      const schema = buildSchema();
      const ajv = new AjvCtor({ allErrors: true, strict:false });
      const validate = ajv.compile(schema);
      const ok = validate(items);
      vm.datasets.push({
        fileName, varName, items, schema, errors: ok ? [] : (validate.errors || [])
      });
      if (vm.active === null) vm.active = vm.datasets.length - 1;
      vm.$nextTick(() => { vm.attachDnD(); });
    } catch (err) {
      vm.datasets.push({
        fileName, varName: 'DATA', items: [],
        schema: buildSchema(),
        errors: [{ message: 'Parseo fallido: ' + err.message }]
      });
    }
  }

  // Exportar todos
  document.getElementById('exportAllBtn').addEventListener('click', () => vm.exportAll());
  </script>
</body>
</html>
