<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Editor de acciones PF2e</title>

<!-- Tabulator CSS -->
<link href="https://unpkg.com/tabulator-tables@5.6.0/dist/css/tabulator.min.css" rel="stylesheet">
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
body { background:#0f1115; color:#e6edf3; font:14px/1.45 ui-sans-serif,system-ui; margin:0; padding:20px;}
h1,h3 { color:#79c0ff; }
#acciones { background:#151924; border-radius:8px; padding:10px;}
#editor { background:#fff; color:#000;}
button { background:#79c0ff; color:#0b1420; border:none; border-radius:6px; padding:8px 12px; margin-top:10px; cursor:pointer;}
button:hover { background:#58a6ff; }
input, textarea {border-radius:6px; padding:6px;}
.controls {margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;}
</style>
</head>
<body>
<h1>Editor de Acciones PF2e</h1>

<div class="controls">
  <input type="file" id="fileInput" accept=".js,.json">
  <input type="text" id="urlInput" placeholder="URL raw GitHub .js/.json" size="50">
  <button id="loadUrlBtn">Cargar URL</button>
  <button id="addRowBtn">Añadir fila</button>
  <button id="deleteRowBtn">Eliminar fila seleccionada</button>
  <button id="exportJsBtn">Exportar JS</button>
  <input type="text" id="varNameInput" placeholder="Nombre de variable en JS">
</div>

<div id="acciones"></div>

<h3>Descripción seleccionada</h3>
<div id="editor" style="height:200px;"></div>

<!-- Tabulator JS -->
<script src="https://unpkg.com/tabulator-tables@5.6.0/dist/js/tabulator.min.js"></script>
<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const quill = new Quill('#editor', { theme: 'snow' });
  let varName = "";
  let tableData = [];

  // Crear tabla
  const table = new Tabulator("#acciones",{
    layout:"fitColumns",
    reactiveData:true,
    selectable:1,
    columns:[
      {title:"Título", field:"title", editor:"input"},
      {title:"Subtítulo", field:"subtitle", editor:"input"},
      {title:"Referencia", field:"reference", editor:"input"},
      {title:"Traits", field:"traits", editor:"input"},
      {title:"Bullets", field:"bullets", editor:"input"},
    ],
    data: tableData,
    rowSelectionChanged:(data)=>{
      if(data.length){
        quill.root.innerHTML = data[0].description || "";
      } else {
        quill.root.innerHTML = "";
      }
    },
    cellEdited:(cell)=>{
      const rowData = cell.getRow().getData();
      if(table.getSelectedData()[0] === rowData){
        rowData.description = quill.root.innerHTML;
      }
    }
  });

  // Cargar desde archivo
  document.getElementById('fileInput').addEventListener('change', async (e)=>{
    if(!e.target.files.length) return;
    const text = await e.target.files[0].text();
    loadFromText(text, e.target.files[0].name.split('.').pop());
    e.target.value="";
  });

  // Cargar desde URL
  document.getElementById('loadUrlBtn').addEventListener('click', async ()=>{
    const url = toRaw(document.getElementById('urlInput').value.trim());
    if(!url) return alert("Introduce URL");
    const res = await fetch(url);
    if(!res.ok) return alert("Error HTTP "+res.status);
    const text = await res.text();
    loadFromText(text, url.split('.').pop());
  });

  function toRaw(u){
    if(u.includes('github.com/') && u.includes('/blob/')){
      return u.replace('github.com/','raw.githubusercontent.com/').replace('/blob/','/');
    }
    return u;
  }

  function loadFromText(text, ext){
    text = text.replace(/^\uFEFF/,'');
    let arr;
    if(ext==="json"){
      arr = JSON.parse(text);
    } else {
      const m = /(var|let|const)\s+([A-Za-z$_][\w$]*)\s*=\s*

\[/.exec(text);
      if(!m) return alert("No se encontró asignación de array en JS");
      varName = m[2];
      const start = text.indexOf('[', m.index);
      let depth = 0, end=-1;
      for(let i=start;i<text.length;i++){
        if(text[i]=='[') depth++;
        else if(text[i]==']'){ depth--; if(depth===0){ end=i; break; } }
      }
      if(end<0) return alert("No se cerró el array");
      const literal = text.slice(start, end+1);
      arr = (new Function("return "+literal))();
    }
    if(!Array.isArray(arr)) return alert("El archivo no contiene un array válido");
    tableData.length=0;
    arr.forEach(o=>{
      tableData.push({
        title:o.title||"",
        subtitle:o.subtitle||"",
        reference:o.reference||"",
        traits:Array.isArray(o.traits)?o.traits.join(", "):(o.traits||""),
        description:o.description||"",
        bullets:Array.isArray(o.bullets)?o.bullets.join(" | "):(o.bullets||"")
      });
    });
    table.replaceData(tableData);
    document.getElementById('varNameInput').value = varName;
  }

  // Añadir fila
  document.getElementById('addRowBtn').addEventListener('click',()=>{
    table.addRow({title:"",subtitle:"",reference:"",traits:"",description:"",bullets:""});
  });

  // Eliminar fila
  document.getElementById('deleteRowBtn').addEventListener('click',()=>{
    const sel = table.getSelectedRows();
    if(sel.length) sel[0].delete();
  });

  // Sincronizar descripción
  quill.on('text-change',()=>{
    const sel = table.getSelectedData();
    if(sel.length){
      sel[0].description = quill.root.innerHTML;
    }
  });

  // Exportar JS
  document.getElementById('exportJsBtn').addEventListener('click',()=>{
    const name = document.getElementById('varNameInput').value.trim() || varName || "pf2eData";
    const arr = table.getData().map(o=>({
      title:o.title,
      subtitle:o.subtitle,
      reference:o.reference,
      traits:o.traits.split(',').map(s=>s.trim()).filter(Boolean),
      description:o.description,
      bullets:o.bullets.split('|').map(s=>s.trim()).filter(Boolean)
    }));
    const js = `const ${name} = ${JSON.stringify(arr,null,2)};\n`;
    const blob = new Blob([js], {type:'text/javascript'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name+".js";
    a.click();
  });

});
</script>
</body>
</html>
