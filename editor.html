<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Editor PF2e – WYSIWYG</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
body { font-family: system-ui, sans-serif; margin:0; background:#0f1115; color:#e6e6e6; }
header { padding:10px; background:#12151b; display:flex; gap:10px; align-items:center; }
main { display:grid; grid-template-columns: 300px 1fr; height:calc(100vh - 50px); }
aside { border-right:1px solid #222; overflow:auto; padding:10px; }
section { padding:10px; overflow:auto; }
input, select, textarea { width:100%; margin-bottom:6px; padding:6px; background:#12151b; color:#e6e6e6; border:1px solid #273041; border-radius:4px; }
button { padding:6px 10px; border:none; border-radius:4px; cursor:pointer; }
button.primary { background:#1e88e5; color:white; }
button.danger { background:#c62828; color:white; }
.card { border:1px solid #222; padding:8px; margin-bottom:6px; border-radius:4px; background:#0f131a; }
#editor { background:white; color:black; }
</style>
</head>
<body>
<header>
  <input type="file" id="fileInput" accept=".js" multiple>
  <button id="exportBtn" class="primary">Exportar</button>
  <span id="status"></span>
</header>
<main id="app">
  <aside>
    <div v-for="(item, idx) in items" :key="idx" class="card" @click="selectItem(idx)" style="cursor:pointer">
      <div v-if="item.header"><strong>Sección:</strong> {{ item.header }}</div>
      <div v-else><strong>{{ item.title }}</strong><br><small>{{ item.icon }}</small></div>
    </div>
  </aside>
  <section v-if="current">
    <div v-if="current.header">
      <label>Header</label>
      <input v-model="current.header">
    </div>
    <div v-else>
      <label>Título</label>
      <input v-model="current.title">
      <label>Icon</label>
      <input v-model="current.icon">
      <label>Subtitle</label>
      <input v-model="current.subtitle">
      <label>Reference</label>
      <input v-model="current.reference">
      <label>Descripción</label>
      <div id="editor"></div>
      <label>Bullets</label>
      <div v-for="(b, bi) in current.bullets" :key="bi" style="display:flex; gap:4px; margin-bottom:4px;">
        <input v-model="current.bullets[bi]">
        <button class="danger" @click.prevent="current.bullets.splice(bi,1)">X</button>
      </div>
      <button @click.prevent="current.bullets.push('')">Añadir bullet</button>
    </div>
  </section>
</main>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/acorn@8/dist/acorn.min.js"></script>
<script src="https://unpkg.com/prettier@3/standalone.js"></script>
<script src="https://unpkg.com/prettier@3/parser-babel.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
const { createApp } = Vue;
function astToJs(node) {
  switch (node.type) {
    case 'ArrayExpression': return node.elements.map(el => astToJs(el));
    case 'ObjectExpression':
      const obj = {};
      for (const p of node.properties) {
        const key = p.key.type === 'Identifier' ? p.key.name : p.key.value;
        obj[key] = astToJs(p.value);
      }
      return obj;
    case 'Literal': return node.value;
    default: return null;
  }
}
function parseJsArrayAssignment(code) {
  const ast = acorn.parse(code, { ecmaVersion: 2020 });
  for (const n of ast.body) {
    if (n.type === 'ExpressionStatement' && n.expression.type === 'AssignmentExpression') {
      if (n.expression.right.type === 'ArrayExpression') {
        return { varName: n.expression.left.name, items: astToJs(n.expression.right) };
      }
    }
  }
  throw new Error('No se encontró array asignado');
}
function toAssignmentJs(varName, items) {
  const raw = `${varName} = ${JSON.stringify(items, null, 2)};`;
  try { return prettier.format(raw, { parser:'babel', plugins:[prettierPlugins.babel] }); }
  catch { return raw; }
}
const app = createApp({
  data:()=>({ items:[], varName:'', current:null, quill:null }),
  methods:{
    selectItem(i){
      this.current = this.items[i];
      if (!this.current.header) {
        this.$nextTick(()=>{
          if (!this.quill) {
            this.quill = new Quill('#editor', { theme:'snow' });
            this.quill.on('text-change', ()=>{
              this.current.description = this.quill.root.innerHTML;
            });
          }
          this.quill.root.innerHTML = this.current.description || '';
        });
      }
    }
  }
});
const vm = app.mount('#app');
document.getElementById('fileInput').addEventListener('change', async e=>{
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
    vm.fileName = file.name; // Guarda el nombre original
  try {
    const { varName, items } = parseJsArrayAssignment(text);
    vm.varName = varName;
    vm.items = items;
    vm.current = null;
    document.getElementById('status').textContent = 'Archivo cargado';
  } catch(err) {
    alert(err.message);
  }
});
document.getElementById('exportBtn').addEventListener('click', async () => {
  // Espera por si toAssignmentJs devuelve un Promise
  const code = await Promise.resolve(toAssignmentJs(vm.varName, vm.items));
  const blob = new Blob([code], { type: 'text/javascript;charset=utf-8' });
  saveAs(blob, vm.fileName || (vm.varName + '.js'));
});
</script>
</body>
</html>
