<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editor WYSIWYG — Pathfinder 2e</title>
  <style>
    :root {
      --bg: #f4f5f6; --card: #ffffff; --ink: #19202d; --muted: #57606a;
      --line: #dfe1e6; --accent: #2684ff; --warn: #de350b; --ok: #36b37e;
    }
    body.dark {
      --bg: #17191e; --card: #22262e; --ink: #e6e7e9; --muted: #8b95a7;
      --line: #2c333f; --accent: #4c9aff; --warn: #ff7452; --ok: #57d9a3;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font: 14px/1.5 ui-sans-serif,system-ui; background: var(--bg);
      color: var(--ink); display: grid; grid-template-rows: auto 1fr auto;
      grid-template-areas:
        "hd"
        "main"
        "ft";
    }
    header { grid-area: hd; background: var(--card); border-bottom: 1px solid var(--line);
      padding: 12px 16px; position: sticky; top: 0; z-index: 10;
    }
    header h1 { margin: 0; font-size: 18px; }
    .bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 8px; }
    input, select, button { font-size: 14px; padding: 6px 10px; border-radius: 6px;
      border: 1px solid var(--line); background: var(--card); color: var(--ink);
    }
    button { cursor: pointer; }
    button.primary { background: var(--accent); color: #fff; border-color: transparent; }
    button.danger { background: var(--warn); color: #fff; border-color: transparent; }
    .kbd { font-family: ui-monospace, monospace; background: var(--line); padding: 2px 4px; border-radius: 4px; }
    .layout { grid-area: main; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
    .panel { background: var(--card); border: 1px solid var(--line); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; }
    .panel.split { height: calc(100vh - 200px); }
    .controls { margin-bottom: 8px; display: flex; gap: 6px; flex-wrap: wrap; }
    table { width: 100%; border-collapse: separate; border-spacing: 0 8px; flex: 1; overflow: auto; }
    thead th { position: sticky; top: 0; background: var(--card); padding: 8px; text-align: left; color: var(--muted); border-bottom: 1px solid var(--line); }
    tbody td { padding: 8px; vertical-align: top; }
    .ce { min-height: 28px; padding: 6px; border: 1px dashed transparent; border-radius: 4px; background: #0000; }
    .ce:focus { outline: none; border-color: var(--accent); background: hsla(210,100%,50%,.05); }
    .ce.placeholder:empty:before { content: attr(data-ph); color: var(--muted); }
    .row-actions { display: flex; gap: 4px; align-items: center; }
    .status { margin-top: 8px; font-size: 13px; }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--warn); }
    .preview { overflow: auto; flex: 1; }
    .card { border: 1px solid var(--line); border-radius: 6px; padding: 10px; margin-bottom: 10px; }
    .card .title { font-weight: 700; }
    .card .subtitle { color: var(--muted); margin-bottom: 6px; }
    .card .traits { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 6px; }
    .card .trait { background: var(--line); border-radius: 4px; padding: 2px 6px; font-size: 12px; }
    .card .desc { white-space: pre-wrap; margin-bottom: 6px; }
    .card .bullets { margin: 0 0 0 16px; }
    #toolbar {
      position: fixed; bottom: 24px; right: 24px; display: none; gap: 4px; padding: 6px; background: var(--card);
      border: 1px solid var(--line); border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,.1);
    }
    #toolbar button { padding: 4px 6px; }
    #toolbar .sep { width:1px; background: var(--line); margin: 0 6px; }
  </style>
</head>
<body>

<header>
  <h1>Editor WYSIWYG — Pathfinder 2e</h1>
  <div class="bar">
    <input type="file" id="fileInput" />
    <input type="text" id="urlInput" placeholder="URL raw de GitHub" style="flex:1" />
    <button id="btnLoadUrl" class="primary">Cargar</button>
    <button id="btnDark" class="ghost">Modo oscuro</button>
  </div>
  <div class="bar">
    <input type="text" id="varName" placeholder="Variable (data_…)" value="data_action" />
    <input type="text" id="fileName" placeholder="Archivo output (.js)" value="data_action.js" />
    <button id="btnDownload" class="primary">Descargar .js</button>
  </div>
</header>

<div class="layout">
  <!-- Panel de edición -->
  <div class="panel split">
    <div class="controls">
      <button id="btnAdd" class="primary">Añadir fila</button>
      <button id="btnValidate">Validar</button>
      <button id="btnClear" class="danger">Vaciar todo</button>
    </div>
    <div id="status" class="status err">Sin datos. Carga un archivo.</div>
    <table>
      <thead>
        <tr>
          <th style="width:18ch">title</th>
          <th style="width:16ch">subtitle</th>
          <th style="width:16ch">reference</th>
          <th style="width:16ch">traits</th>
          <th style="min-width:200px">description</th>
          <th style="width:20ch">bullets</th>
          <th style="width:14ch">Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- Panel de vista previa -->
  <div class="panel">
    <strong>Vista previa</strong>
    <div id="preview" class="preview"></div>
  </div>
</div>

<!-- Barra flotante de formato -->
<div id="toolbar">
  <button data-cmd="bold"><strong>B</strong></button>
  <button data-cmd="italic"><em>I</em></button>
  <button data-cmd="underline"><u>U</u></button>
  <div class="sep"></div>
  <button data-cmd="insertUnorderedList">• List</button>
  <button data-cmd="insertOrderedList">1. List</button>
  <div class="sep"></div>
  <button id="btnLink">Enlace</button>
  <button data-cmd="unlink">Quitar enlace</button>
  <div class="sep"></div>
  <button id="btnClearFmt">Limpiar formato</button>
</div>

<script>
/* — Estado global — */
let dataset = [], focusedCell = null, varNameDetected = null;

/* — Util helpers — */
const $ = s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
function setStatus(msg, ok=false){
  const st = $('#status');
  st.textContent=msg;
  st.className = 'status ' + (ok?'ok':'err');
}
function toRawUrl(u){
  return u.includes('/blob/')
    ? u.replace('github.com/','raw.githubusercontent.com/').replace('/blob/','/')
    : u;
}
/* — Parsing robusto de “X = [ … ];” con o sin var/const/let — */
function parseVarJs(text){
  const re = new RegExp(String.raw`^(?:var|let|const)?\s*([\w$]+)\s*=\s*(

\[[\s\S]*\]

)\s*;?\s*$`,'m');
  const m = text.match(re);
  if(!m) throw new Error('No se encontró “X = [ … ];” en el archivo.');
  varNameDetected = m[1];
  const arr = JSON.parse(m[2]);
  if(!Array.isArray(arr)) throw new Error('El contenido no es un array.');
  return arr;
}
/* — Serializar — */
function downloadJs(name, arr){
  const content = 'var '+name+' = '+JSON.stringify(arr,null,2)+';\n';
  const blob = new Blob([content],{type:'application/javascript'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = $('#fileName').value || (name+'.js');
  document.body.appendChild(a); a.click(); a.remove();
}
/* — Render tabla de edición — */
function ensure(i){
  dataset[i] ||= { title:'',subtitle:'',reference:'',traits:[],description:'',bullets:[] };
}
function renderTable(){
  const tbody = $('#tbody');
  tbody.innerHTML = '';
  dataset.forEach((it,idx)=>{
    ensure(idx);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="title" data-ph="Título">${it.title}</div></td>
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="subtitle" data-ph="Subtítulo">${it.subtitle}</div></td>
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="reference" data-ph="Referencia">${it.reference}</div></td>
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="traits" data-ph="trait1, trait2">${(it.traits||[]).join(', ')}</div></td>
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="description" data-ph="Descripción…">${it.description}</div></td>
      <td><div class="ce" contenteditable data-idx="${idx}" data-field="bullets" data-ph="Una línea = bullet">${(it.bullets||[]).join('\n')}</div></td>
      <td class="row-actions">
        <button data-act="up"    data-idx="${idx}">↑</button>
        <button data-act="down"  data-idx="${idx}">↓</button>
        <button data-act="dup"   data-idx="${idx}">⎘</button>
        <button data-act="del"   data-idx="${idx}" style="color:var(--warn)">🗑</button>
      </td>`;
    tbody.appendChild(tr);
  });
  // placeholder styling
  $$('.ce').forEach(el=>el.classList.toggle('placeholder', !el.textContent.trim()));
  refreshPreview();
}

/* — Vista previa — */
function refreshPreview(){
  const pr = $('#preview');
  pr.innerHTML = '';
  dataset.forEach(it=>{
    const c = document.createElement('div'); c.className='card';
    const t = document.createElement('div'); t.className='title'; t.innerText = it.title;
    const s = document.createElement('div'); s.className='subtitle'; s.innerText = it.subtitle;
    const r = document.createElement('div'); r.className='subtitle'; r.innerText = it.reference;
    const trts = document.createElement('div'); trts.className='traits';
    (it.traits||[]).forEach(x=>{
      const sp = document.createElement('span'); sp.className='trait'; sp.innerText = x;
      trts.appendChild(sp);
    });
    const d = document.createElement('div'); d.className='desc'; d.innerHTML = it.description.replace(/\n/g,'<br>');
    const ul = document.createElement('ul'); ul.className='bullets';
    (it.bullets||[]).forEach(x=>{
      const li=document.createElement('li'); li.innerText=x; ul.appendChild(li);
    });
    c.append(t,s,trts,r,d,ul);
    pr.appendChild(c);
  });
}

/* — Sincronizar campos — */
document.addEventListener('input', e=>{
  const ce = e.target.closest('.ce');
  if(!ce) return;
  const i = +ce.dataset.idx, f = ce.dataset.field;
  ensure(i);
  let v = ce.innerText;
  if(f==='traits') dataset[i][f] = v.split(',').map(x=>x.trim()).filter(Boolean);
  else if(f==='bullets') dataset[i][f] = v.split('\n').map(x=>x.trim()).filter(Boolean);
  else dataset[i][f] = v;
  saveLocal();
  renderTable();
});

/* — Fila acciones — */
document.addEventListener('click', e=>{
  const b = e.target.closest('button[data-act]');
  if(!b) return;
  const i = +b.dataset.idx, act = b.dataset.act;
  if(act==='del'){ dataset.splice(i,1); }
  if(act==='dup'){ dataset.splice(i+1,0,JSON.parse(JSON.stringify(dataset[i]))); }
  if(act==='up' && i>0){ [dataset[i-1],dataset[i]] = [dataset[i],dataset[i-1]]; }
  if(act==='down' && i<dataset.length-1){ [dataset[i+1],dataset[i]] = [dataset[i],dataset[i+1]]; }
  saveLocal(); renderTable();
});

/* — Control flotante */ 
function showToolbar(el){
  focusedCell = el;
  const tb = $('#toolbar'), r=el.getBoundingClientRect();
  tb.style.left = r.left + 'px'; tb.style.top = (r.bottom+8)+'px'; tb.style.display='flex';
}
function hideToolbar(){ $('#toolbar').style.display='none'; }
document.addEventListener('focusin', e=>{
  const ce = e.target.closest('.ce');
  if(ce) showToolbar(ce);
});
document.addEventListener('click', e=>{
  if(!e.target.closest('.ce') && !e.target.closest('#toolbar')) hideToolbar();
});

/* — Toolbar commands — */
$('#toolbar').addEventListener('click', e=>{
  const cmd = e.target.closest('button')?.dataset.cmd;
  if(cmd){ document.execCommand(cmd,false,null); focusedCell.dispatchEvent(new Event('input')); }
  else if(e.target.id==='btnLink'){
    const url = prompt('URL:');
    if(url) document.execCommand('createLink',false,url), focusedCell.dispatchEvent(new Event('input'));
  }
  else if(e.target.id==='btnClearFmt'){
    document.execCommand('removeFormat'), document.execCommand('unlink'),
    focusedCell.dispatchEvent(new Event('input'));
  }
});

/* — File / URL load — */
$('#fileInput').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try {
      dataset = parseVarJs(r.result);
      $('#varName').value = varNameDetected;
      setStatus(`Cargado ${f.name}`, true);
      renderTable();
    } catch(err){ setStatus(err.message, false); }
  };
  r.readAsText(f);
});
$('#btnLoadUrl').addEventListener('click', async ()=>{
  const url = toRawUrl($('#urlInput').value.trim());
  if(!url) return setStatus('URL vacía', false);
  try {
    const res = await fetch(url);
    if(!res.ok) throw new Error(res.statusText);
    dataset = parseVarJs(await res.text());
    $('#varName').value = varNameDetected;
    setStatus('Cargado desde URL', true);
    renderTable();
  } catch(err){ setStatus(err.message, false); }
});

/* — Otras acciones — */
$('#btnAdd').onclick = ()=>{ dataset.push({}); renderTable(); saveLocal(); };
$('#btnClear').onclick = ()=>{ if(confirm('Vaciar todo?')){ dataset=[]; renderTable(); saveLocal(); } };
$('#btnValidate').onclick = ()=>{
  const issues=[];
  if(!Array.isArray(dataset)) issues.push('No es array');
  dataset.forEach((o,i)=> {
    if(!o.title?.trim()) issues.push(`#${i+1} falta title`);
  });
  setStatus(issues.length?issues.join(' | '):'OK ✔', issues.length===0);
};
/* — Autosave en localStorage — */
function saveLocal(){
  localStorage.setItem('pf2e_editor', JSON.stringify({dataset, varName:$('#varName').value, fileName:$('#fileName').value}));
}
function loadLocal(){
  try {
    const st = JSON.parse(localStorage.getItem('pf2e_editor'));
    if(st?.dataset) {
      dataset=st.dataset;
      $('#varName').value=st.varName;
      $('#fileName').value=st.fileName;
    }
  } catch{}
}
window.onload = ()=>{
  loadLocal();
  if(dataset.length) { renderTable(); setStatus('Datos restaurados', true); }
  else setStatus('Sin datos. Carga un archivo.', false);
};

/* — Descarga — */
$('#btnDownload').onclick = ()=>{
  const name = ($('#varName').value||'data_action').replace(/[^\w$]/g,'_');
  downloadJs(name, dataset);
};

/* — Modo oscuro — */
$('#btnDark').onclick = ()=>{
  document.body.classList.toggle('dark');
  saveLocal();
};
document.addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='d'){
    e.preventDefault(); $('#btnDark').click();
  }
});
</script>

</body>
</html>
