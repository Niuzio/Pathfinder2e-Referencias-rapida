<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Editor de datos JS — Pathfinder 2e (Texto)</title>
<style>
  :root {
    --bg: #0f1115; --panel: #161a22; --muted: #8b95a7;
    --fg: #e6edf3; --accent: #58a6ff; --danger: #ff6b6b; --ok: #3fb950;
    --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  }
  * { box-sizing: border-box; }
  body { margin:0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; height: 100vh; display: grid; grid-template-columns: 300px 1fr 420px; grid-template-rows: auto 1fr auto; grid-template-areas:
    "header header header"
    "left main right"
    "footer footer footer";
  }
  header, footer { grid-area: header / header / header / header; padding: 10px 12px; background: #0b0d12; border-bottom: 1px solid #1f2633; }
  footer { grid-area: footer; border-top: 1px solid #1f2633; border-bottom: none; font-size: 12px; color: var(--muted); }
  h1 { font-size: 16px; margin: 0; }
  small { color: var(--muted); }
  .col { padding: 10px; overflow: auto; }
  .left { grid-area: left; background: var(--panel); border-right: 1px solid #1f2633; }
  .main { grid-area: main; }
  .right { grid-area: right; background: var(--panel); border-left: 1px solid #1f2633; }
  .section { margin-bottom: 12px; }
  .section h3 { margin: 10px 0 6px; font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }
  label { display:block; font-size: 12px; margin: 8px 0 4px; color: var(--muted); }
  input[type="text"], input[type="search"], textarea, select {
    width: 100%; padding: 8px 10px; background: #0b0d12; color: var(--fg);
    border: 1px solid #263043; border-radius: 6px; outline: none;
  }
  textarea { font-family: var(--mono); line-height: 1.35; min-height: 90px; resize: vertical; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .btn { background: #1f2633; color: var(--fg); border: 1px solid #2c394f; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
  .btn:hover { border-color: var(--accent); }
  .btn.danger { border-color: #5a2b2b; color: #ffb3b3; }
  .btn.ok { border-color: #244c32; color: #b6f0c1; }
  .list { display: grid; gap: 4px; }
  .list button { text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .pill { display:inline-block; padding: 2px 6px; border:1px solid #2c394f; border-radius:999px; font-size:12px; color:var(--muted) }
  .inline { display: inline-flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .toolbar { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
  .split { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  details { border:1px solid #2c394f; border-radius:6px; padding: 6px 8px; background:#0b0d12; }
  details > summary { cursor: pointer; color: var(--muted); }
  .hint { font-size: 12px; color: var(--muted); }
  .counter { font-size: 11px; color: var(--muted); text-align: right; }
  .warn { color: #ffd28f; }
  .oktxt { color: var(--ok); }
</style>
</head>
<body>
  <header>
    <h1>Editor de datos JS — Pathfinder 2e <small>(modo 100% texto)</small></h1>
  </header>

  <div class="col left">
    <div class="section">
      <h3>Cargar desde repositorio</h3>
      <div class="inline">
        <span class="pill">Owner</span><input id="ghOwner" type="text" value="Niuzio" />
        <span class="pill">Repo</span><input id="ghRepo" type="text" value="Pathfinder2e-Referencias-rapida" />
        <span class="pill">Dir</span><input id="ghDir" type="text" value="js" />
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnList" class="btn">Listar .js</button>
        <select id="fileSelect" title="Archivos .js"></select>
        <button id="btnLoadSelected" class="btn">Cargar seleccionado</button>
      </div>
      <div class="hint">Usa la API de GitHub para listar js/*.js. Si falla, usa URL o archivo local.</div>
    </div>

    <div class="section">
      <h3>Cargar desde URL</h3>
      <input id="rawUrl" type="text" placeholder="https://raw.githubusercontent.com/.../archivo.js" />
      <button id="btnLoadUrl" class="btn">Cargar URL</button>
    </div>

    <div class="section">
      <h3>Cargar archivo local</h3>
      <input id="localFile" type="file" accept=".js" />
    </div>

    <div class="section">
      <h3>Objetos</h3>
      <div class="toolbar">
        <button id="btnAdd" class="btn">Añadir</button>
        <button id="btnDup" class="btn">Duplicar</button>
        <button id="btnDel" class="btn danger">Eliminar</button>
      </div>
      <div id="objectList" class="list" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="col main">
    <div class="section">
      <h3>Encabezados</h3>
      <div class="row">
        <div>
          <label for="title">title</label>
          <input id="title" type="text" />
        </div>
        <div>
          <label for="subtitle">subtitle</label>
          <input id="subtitle" type="text" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="reference">reference</label>
          <input id="reference" type="text" />
        </div>
        <div>
          <label for="traits">traits (separados por coma)</label>
          <input id="traits" type="text" placeholder="ej. ataque, concentración" />
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Descripción</h3>
      <label for="description">description (texto plano — puedes usar etiquetas HTML si tu render las soporta)</label>
      <textarea id="description" rows="10" spellcheck="false"></textarea>
      <div class="counter"><span id="descCount">0</span> chars</div>
    </div>

    <div class="section">
      <h3>Bullets</h3>
      <label for="bullets">Una línea = un bullet</label>
      <textarea id="bullets" rows="8" spellcheck="false" placeholder="• Primera línea&#10;• Segunda línea"></textarea>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnAddBullet" class="btn">Añadir línea</button>
        <button id="btnSortBullets" class="btn">Ordenar</button>
        <button id="btnClearBullets" class="btn danger">Vaciar</button>
      </div>
    </div>

    <div class="section">
      <details id="advDetails">
        <summary>Editor JSON del objeto (avanzado)</summary>
        <div class="hint" style="margin:6px 0">Aquí puedes cambiar cualquier clave del objeto actual. Se sincroniza con los campos de arriba.</div>
        <textarea id="jsonObj" rows="14" spellcheck="false"></textarea>
        <div class="toolbar" style="margin-top:8px">
          <button id="btnJsonToFields" class="btn">Aplicar JSON → Campos</button>
          <button id="btnFieldsToJson" class="btn">Campos → JSON</button>
          <span id="jsonStatus" class="hint"></span>
        </div>
      </details>
    </div>
  </div>

  <div class="col right">
    <div class="section">
      <h3>Archivo</h3>
      <label for="varName">Nombre de variable (var … = [])</label>
      <input id="varName" type="text" placeholder="ej. data_action" />
      <label for="fileName">Nombre de archivo de salida</label>
      <input id="fileName" type="text" placeholder="ej. data_action.js" />
      <div class="toolbar" style="margin-top:8px">
        <button id="btnDownload" class="btn ok">Descargar .js</button>
      </div>
      <div class="hint">Se exporta como: <code>var NOMBRE = [ ... ];</code></div>
    </div>

    <div class="section">
      <h3>Validaciones</h3>
      <div id="valBox" class="hint">Sin validar</div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnValidate" class="btn">Validar dataset</button>
        <button id="btnFindDup" class="btn">Buscar títulos duplicados</button>
      </div>
    </div>

    <div class="section">
      <h3>Buscar y reemplazar</h3>
      <input id="search" type="search" placeholder="Buscar en title/description/bullets" />
      <input id="replace" type="text" placeholder="Reemplazar por…" />
      <div class="toolbar" style="margin-top:8px">
        <button id="btnFind" class="btn">Buscar</button>
        <button id="btnReplaceAll" class="btn">Reemplazar en todos</button>
      </div>
      <div id="srStatus" class="hint"></div>
    </div>
  </div>

  <footer>
    Consejos: usa “Archivo local” si la API de GitHub está limitada. Mantén una copia de seguridad antes de sobrescribir datasets.
  </footer>

<script>
/* ====================== Estado global ====================== */
let dataArray = [];     // Array de objetos actual
let currentIndex = -1;  // Índice del objeto activo
let currentRaw = "";    // Texto original del archivo
let detectedVar = "";   // Nombre de variable detectado del archivo

/* ====================== Utilidades ====================== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);

function download(filename, text) {
  const blob = new Blob([text], { type: "application/javascript" });
  const a = el('a', { href: URL.createObjectURL(blob), download: filename });
  document.body.appendChild(a); a.click(); a.remove();
}

function parseJsDataset(text) {
  // Busca: var NAME = [ ... ];
  const m = text.match(/var\\s+([A-Za-z_$][\\w$]*)\\s*=\\s*(\

\[[\\s\\S]*?\\]

)\\s*;?\\s*$/m);
  if (!m) throw new Error("No se encontró un 'var NOMBRE = [ ... ];' en el archivo.");
  const varName = m[1];
  const arrText = m[2];
  // Intento de parseo como JSON estricto
  try {
    const arr = JSON.parse(arrText);
    return { varName, arr };
  } catch {
    // Si no es JSON estricto, intenta normalizar:
    let j = arrText.trim();
    // 1) Eliminar comentarios // y /* */
    j = j.replace(/\\/\\*[\\s\\S]*?\\*\\//g, "").replace(/(^|\\s)//.*$/gm, "$1");
    // 2) Quitar comas colgantes en objetos/arrays
    j = j.replace(/,(\\s*[\\]

}])/g, "$1");
    // 3) Reemplazar comillas simples por dobles si no rompen escapes
    // (Quick & dirty: mejor mantener datos con comillas dobles ya en el repo)
    // 4) Intento final: eval controlado del array
    try {
      // Evalúa SOLO el array, no el archivo completo
      // new Function retorna el array
      const arr = (new Function("return " + j))();
      if (!Array.isArray(arr)) throw 0;
      return { varName, arr };
    } catch (e) {
      throw new Error("No se pudo parsear el array. Estandariza el archivo a JSON estricto dentro de [ ... ].");
    }
  }
}

function serializeJs(varName, arr) {
  const pretty = JSON.stringify(arr, null, 2);
  return `var ${varName} = ${pretty};\\n`;
}

function setStatus(node, msg, ok=false, warn=false) {
  node.textContent = msg;
  node.className = "hint" + (ok ? " oktxt" : warn ? " warn" : "");
}

function traitsToString(traits) { return (Array.isArray(traits) ? traits : []).join(", "); }
function stringToTraits(s) { return s.split(",").map(x=>x.trim()).filter(Boolean); }

function bulletsToString(bullets) { return (Array.isArray(bullets) ? bullets : []).join("\\n"); }
function stringToBullets(s) { return s.split(/\\r?\\n/).map(x=>x.trim()).filter(Boolean); }

/* ====================== Render de lista ====================== */
function renderList() {
  const box = $("#objectList");
  box.innerHTML = "";
  dataArray.forEach((o, i) => {
    const b = el("button", { className: "btn", textContent: (o.title || "(sin título)") });
    b.onclick = () => loadObject(i);
    box.appendChild(b);
  });
}

/* ====================== Carga de objeto ====================== */
function loadObject(i) {
  currentIndex = i;
  const o = dataArray[i] || {};
  $("#title").value = o.title || "";
  $("#subtitle").value = o.subtitle || "";
  $("#reference").value = o.reference || "";
  $("#traits").value = traitsToString(o.traits);
  $("#description").value = o.description || "";
  $("#bullets").value = bulletsToString(o.bullets);
  $("#descCount").textContent = ($("#description").value || "").length.toString();
  // JSON avanzado
  $("#jsonObj").value = JSON.stringify(o, null, 2);
  setStatus($("#jsonStatus"), "Objeto sincronizado", true);
}

/* ====================== Guardar cambios del objeto activo ====================== */
function saveCurrentFromFields() {
  if (currentIndex < 0) return;
  const o = dataArray[currentIndex] || {};
  o.title = $("#title").value.trim();
  o.subtitle = $("#subtitle").value.trim();
  o.reference = $("#reference").value.trim();
  o.traits = stringToTraits($("#traits").value);
  o.description = $("#description").value;
  o.bullets = stringToBullets($("#bullets").value);
  dataArray[currentIndex] = o;
  $("#jsonObj").value = JSON.stringify(o, null, 2);
  renderList();
}

function applyJsonToFields() {
  if (currentIndex < 0) return;
  try {
    const obj = JSON.parse($("#jsonObj").value);
    dataArray[currentIndex] = obj;
    loadObject(currentIndex);
    setStatus($("#jsonStatus"), "JSON válido y aplicado", true);
  } catch (e) {
    setStatus($("#jsonStatus"), "JSON inválido: " + e.message, false, true);
  }
}

/* ====================== Handlers de edición ====================== */
$("#title").addEventListener("input", saveCurrentFromFields);
$("#subtitle").addEventListener("input", saveCurrentFromFields);
$("#reference").addEventListener("input", saveCurrentFromFields);
$("#traits").addEventListener("input", saveCurrentFromFields);
$("#description").addEventListener("input", () => {
  $("#descCount").textContent = ($("#description").value || "").length.toString();
  saveCurrentFromFields();
});
$("#bullets").addEventListener("input", saveCurrentFromFields);

$("#btnJsonToFields").onclick = applyJsonToFields;
$("#btnFieldsToJson").onclick = () => { saveCurrentFromFields(); setStatus($("#jsonStatus"), "Campos sincronizados → JSON", true); };

/* ====================== Acciones sobre objetos ====================== */
$("#btnAdd").onclick = () => {
  dataArray.push({ title: "", subtitle: "", reference: "", traits: [], description: "", bullets: [] });
  renderList();
};
$("#btnDup").onclick = () => {
  if (currentIndex < 0) return;
  dataArray.splice(currentIndex + 1, 0, JSON.parse(JSON.stringify(dataArray[currentIndex])));
  renderList();
};
$("#btnDel").onclick = () => {
  if (currentIndex < 0) return;
  dataArray.splice(currentIndex, 1);
  currentIndex = Math.min(currentIndex, dataArray.length - 1);
  renderList();
  if (currentIndex >= 0) loadObject(currentIndex);
};

/* ====================== Bullets helpers ====================== */
$("#btnAddBullet").onclick = () => {
  $("#bullets").value = ($("#bullets").value ? $("#bullets").value + "\\n" : "") + "";
  saveCurrentFromFields();
};
$("#btnSortBullets").onclick = () => {
  const lines = stringToBullets($("#bullets").value).sort((a,b)=>a.localeCompare(b));
  $("#bullets").value = lines.join("\\n");
  saveCurrentFromFields();
};
$("#btnClearBullets").onclick = () => {
  $("#bullets").value = "";
  saveCurrentFromFields();
};

/* ====================== Búsqueda y reemplazo ====================== */
$("#btnFind").onclick = () => {
  const q = ($("#search").value || "").toLowerCase().trim();
  if (!q) { $("#srStatus").textContent = "Escribe un término de búsqueda."; return; }
  const hits = [];
  dataArray.forEach((o,i) => {
    const blob = [o.title, o.subtitle, o.reference, o.description, ...(o.bullets||[])].join("\\n").toLowerCase();
    if (blob.includes(q)) hits.push(i);
  });
  $("#srStatus").textContent = hits.length ? `Coincidencias en índices: ${hits.join(", ")}` : "Sin coincidencias.";
};
$("#btnReplaceAll").onclick = () => {
  const q = $("#search").value || "";
  const r = $("#replace").value || "";
  if (!q) { $("#srStatus").textContent = "Escribe qué buscar."; return; }
  let count = 0;
  dataArray = dataArray.map(o => {
    const n = JSON.parse(JSON.stringify(o));
    const rep = s => (s||"").split(q).join(r);
    n.title = rep(n.title); n.subtitle = rep(n.subtitle); n.reference = rep(n.reference); n.description = rep(n.description);
    n.bullets = (n.bullets||[]).map(rep);
    count++;
    return n;
  });
  renderList();
  if (currentIndex >= 0) loadObject(currentIndex);
  $("#srStatus").textContent = `Reemplazo aplicado sobre ${count} objetos.`;
};

/* ====================== Validaciones ====================== */
$("#btnValidate").onclick = () => {
  const msgs = [];
  if (!Array.isArray(dataArray)) msgs.push("El dataset no es un array.");
  dataArray.forEach((o, i) => {
    if (!o.title) msgs.push(`Objeto ${i}: falta title.`);
    if (!("description" in o)) msgs.push(`Objeto ${i}: falta description.`);
    if (!("bullets" in o)) msgs.push(`Objeto ${i}: falta bullets (usa lista vacía si no aplica).`);
    if (o.traits && !Array.isArray(o.traits)) msgs.push(`Objeto ${i}: traits debe ser array.`);
    if (o.bullets && !Array.isArray(o.bullets)) msgs.push(`Objeto ${i}: bullets debe ser array.`);
  });
  setStatus($("#valBox"), msgs.length ? "Problemas:\\n- " + msgs.join("\\n- ") : "OK: Validación básica superada.", msgs.length===0, msgs.length>0);
};
$("#btnFindDup").onclick = () => {
  const seen = new Map(); const dups = [];
  dataArray.forEach((o,i)=> {
    const t = (o.title||"").trim().toLowerCase();
    if (!t) return;
    if (seen.has(t)) dups.push(`${i} ↔ ${seen.get(t)} (${o.title})`);
    else seen.set(t, i);
  });
  setStatus($("#valBox"), dups.length ? "Títulos duplicados:\\n- " + dups.join("\\n- ") : "Sin duplicados.", dups.length===0, dups.length>0);
};

/* ====================== Exportar ====================== */
$("#btnDownload").onclick = () => {
  let varName = ($("#varName").value || detectedVar || "").trim();
  if (!varName) { alert("Indica el nombre de variable (ej. data_action)."); return; }
  let fileName = ($("#fileName").value || (varName + ".js")).trim();
  const text = serializeJs(varName, dataArray);
  download(fileName, text);
};

/* ====================== Cargas ====================== */
async function listRepoFiles() {
  const owner = $("#ghOwner").value.trim();
  const repo = $("#ghRepo").value.trim();
  const dir  = $("#ghDir").value.trim().replace(/^\\/+|\\/+$/g, "");
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${dir}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("No se pudo listar el repo: " + res.status);
  const list = await res.json();
  const jsFiles = list.filter(x => x.type === "file" && /\\.js$/i.test(x.name));
  const sel = $("#fileSelect"); sel.innerHTML = "";
  jsFiles.forEach(f => {
    const opt = el("option", { value: f.download_url, textContent: f.name });
    sel.appendChild(opt);
  });
  if (sel.options.length) sel.selectedIndex = 0;
}

async function loadFromUrl(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("No se pudo cargar: " + res.status);
  const text = await res.text();
  currentRaw = text;
  const { varName, arr } = parseJsDataset(text);
  detectedVar = varName;
  $("#varName").value = varName;
  $("#fileName").value = (new URL(url)).pathname.split("/").pop() || (varName + ".js");
  dataArray = arr;
  renderList();
  if (dataArray.length) loadObject(0);
}

$("#btnList").onclick = async () => {
  try { await listRepoFiles(); } catch (e) { alert(e.message); }
};
$("#btnLoadSelected").onclick = async () => {
  const sel = $("#fileSelect");
  if (!sel.value) { alert("Primero lista y selecciona un archivo."); return; }
  try { await loadFromUrl(sel.value); } catch (e) { alert(e.message); }
};
$("#btnLoadUrl").onclick = async () => {
  const u = $("#rawUrl").value.trim();
  if (!u) return alert("Pega una URL raw de GitHub u otra fuente.");
  try { await loadFromUrl(u); } catch (e) { alert(e.message); }
};
$("#localFile").addEventListener("change", async (ev) => {
  const f = ev.target.files[0];
  if (!f) return;
  const text = await f.text();
  currentRaw = text;
  try {
    const { varName, arr } = parseJsDataset(text);
    detectedVar = varName;
    $("#varName").value = varName;
    $("#fileName").value = f.name || (varName + ".js");
    dataArray = arr;
    renderList();
    if (dataArray.length) loadObject(0);
  } catch (e) {
    alert(e.message);
  }
});
</script>
</body>
</html>
