<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Editor JS - Pathfinder 2e</title>
<style>
  body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
  #sidebar { width: 250px; background: #f0f0f0; overflow-y: auto; padding: 0.5rem; }
  #main { flex: 1; display: flex; flex-direction: column; padding: 0.5rem; }
  label { font-weight: bold; margin-top: 0.5rem; display: block; }
  input, select, button { width: 100%; margin-top: 0.25rem; }
  #objectList button { display: block; width: 100%; text-align: left; margin: 0.25rem 0; }
  #toolbar { margin-top: auto; }
</style>
<!-- CKEditor 5 Classic -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
</head>
<body>

<div id="sidebar">
  <h3>Archivos JS</h3>
  <select id="fileSelect"></select>
  <h3>Objetos</h3>
  <div id="objectList"></div>
  <button id="addObjectBtn">âž• AÃ±adir objeto</button>
</div>

<div id="main">
  <label>TÃ­tulo</label>
  <input id="titleInput">
  <label>SubtÃ­tulo</label>
  <input id="subtitleInput">
  <label>Referencia</label>
  <input id="referenceInput">
  <label>Traits (coma)</label>
  <input id="traitsInput">
  <label>DescripciÃ³n</label>
  <div id="descriptionEditor"></div>
  <label>Bullets</label>
  <div id="bulletsEditor"></div>
  <div id="toolbar">
    <button id="saveBtn">ðŸ’¾ Descargar archivo</button>
  </div>
</div>

<script>
const files = [
  "data_action.js","data_bonusaction.js","data_condition.js","data_environment.js",
  "data_exploration_general.js","data_exploration_skill.js","data_movement.js",
  "data_optional.js","data_reaction.js","data_rest.js","quickref.js"
];
const repoBase = "https://raw.githubusercontent.com/Niuzio/Pathfinder2e-Referencias-rapida/master/js/";

let currentData = [], currentIndex = -1;
let descEditor, bulletsEditor;

const fileSelect = document.getElementById('fileSelect');
files.forEach(f => {
  const opt = document.createElement('option');
  opt.value = f; opt.textContent = f;
  fileSelect.appendChild(opt);
});
fileSelect.addEventListener('change', loadFile);

async function loadFile() {
  const url = repoBase + fileSelect.value;
  const res = await fetch(url);
  const text = await res.text();
  const match = text.match(/=\\s*(\

\[.*\\]

);?$/s);
  if (!match) { alert("No se encontrÃ³ array en el archivo"); return; }
  currentData = JSON.parse(match[1]);
  renderList();
}

function renderList() {
  const list = document.getElementById('objectList');
  list.innerHTML = '';
  currentData.forEach((obj,i) => {
    const btn = document.createElement('button');
    btn.textContent = obj.title || "(sin tÃ­tulo)";
    btn.onclick = () => loadObject(i);
    list.appendChild(btn);
  });
}

function loadObject(i) {
  currentIndex = i;
  const o = currentData[i];
  document.getElementById('titleInput').value = o.title || '';
  document.getElementById('subtitleInput').value = o.subtitle || '';
  document.getElementById('referenceInput').value = o.reference || '';
  document.getElementById('traitsInput').value = (o.traits||[]).join(', ');
  descEditor.setData(o.description || '');
  bulletsEditor.setData((o.bullets||[]).join('<br>'));
}

document.getElementById('addObjectBtn').onclick = () => {
  currentData.push({title:'',subtitle:'',reference:'',traits:[],description:'',bullets:[]});
  renderList();
};

document.getElementById('saveBtn').onclick = () => {
  if (currentIndex >= 0) saveCurrent();
  const js = "var " + fileSelect.value.replace('.js','') + " = " + JSON.stringify(currentData,null,2) + ";";
  const blob = new Blob([js], {type:"application/javascript"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileSelect.value;
  a.click();
};

function saveCurrent() {
  const o = currentData[currentIndex];
  o.title = document.getElementById('titleInput').value;
  o.subtitle = document.getElementById('subtitleInput').value;
  o.reference = document.getElementById('referenceInput').value;
  o.traits = document.getElementById('traitsInput').value.split(',').map(t=>t.trim()).filter(Boolean);
  o.description = descEditor.getData();
  o.bullets = bulletsEditor.getData().split(/<br\\s*\\/?>/).map(b=>b.trim()).filter(Boolean);
}

// Inicializar CKEditor
ClassicEditor.create(document.querySelector('#descriptionEditor'), {
  toolbar: ['bold','italic','underline','fontColor','highlight','link','insertImage','bulletedList','numberedList','blockQuote','insertTable','undo','redo']
}).then(ed => descEditor = ed);

ClassicEditor.create(document.querySelector('#bulletsEditor'), {
  toolbar: ['bold','italic','underline','fontColor','highlight','link','bulletedList','numberedList','undo','redo']
}).then(ed => bulletsEditor = ed);

// Cargar primero
fileSelect.value = files[0];
loadFile();
</script>

</body>
</html>
